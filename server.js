/**
 * @author Alexander Echeverria
 * @file server.js
 * @description Servidor principal con configuraci√≥n simple
 * @location server.js
 */

const express = require('express');
const bodyParser = require('body-parser');
const cors = require('cors');
const db = require('./app/config/db.config');
const bcrypt = require('bcrypt');

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë        üîß CONFIGURACI√ìN DEL SISTEMA (EDITABLE)          ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

const CONFIG = {
    // ‚öôÔ∏è RECREAR TABLAS: true = Elimina y recrea todas las tablas (BORRA DATOS)
    RECREATE_TABLES: true,  // ‚¨ÖÔ∏è Cambia a false para NO recrear tablas
    
    // üë• INSERTAR USUARIOS: true = Crea usuarios por defecto
    INSERT_USERS: true,     // ‚¨ÖÔ∏è Cambia a false para NO insertar usuarios
    
    // üì¶ INSERTAR DATOS DE PRUEBA: true = Crea productos y lotes de ejemplo
    INSERT_SAMPLE_DATA: true  // ‚¨ÖÔ∏è Cambia a false para NO insertar datos de prueba
};

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë              NO EDITAR DEBAJO DE ESTA L√çNEA             ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

const app = express();

// ========== MIDDLEWARES ==========
app.use(cors({
    origin: ['http://localhost:3000', 'http://localhost:3001'],
    credentials: true
}));

app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));

// ========== IMPORTAR RUTAS ==========
const productRoutes = require('./app/routers/productsRoutes');
const userRoutes = require('./app/routers/userRoutes');
const clientRoutes = require('./app/routers/clientRoutes');
const workerRoutes = require('./app/routers/workerRoutes');
const invoiceRoutes = require('./app/routers/invoiceRoutes');
const paymentRoutes = require('./app/routers/paymentRoutes');
const batchRoutes = require('./app/routers/batchRoutes');
const statisticsRoutes = require('./app/routers/statisticsRoutes');
const inventoryMovementRoutes = require('./app/routers/inventoryMovementRoutes');
const auditLogRoutes = require('./app/routers/auditLogRoutes');
const alertsRoutes = require('./app/routers/alertsRoutes');
const receiptRoutes = require('./app/routers/receiptRoutes');

// ========== CONFIGURAR RUTAS ==========
app.use('/api/products', productRoutes);
app.use('/api/users', userRoutes);
app.use('/api/clients', clientRoutes);
app.use('/api/workers', workerRoutes);
app.use('/api/invoices', invoiceRoutes);
app.use('/api/payments', paymentRoutes);
app.use('/api/batches', batchRoutes);
app.use('/api/statistics', statisticsRoutes);
app.use('/api/inventory', inventoryMovementRoutes);
app.use('/api/audit', auditLogRoutes);
app.use('/api/alerts', alertsRoutes);
app.use('/api/receipts', receiptRoutes);

// ========== RUTA DE PRUEBA ==========
app.get('/', (req, res) => {
    res.json({ 
        message: "Farmacia Elizabeth API",
        version: "2.0.0",
        configuration: {
            tablesRecreated: CONFIG.RECREATE_TABLES,
            usersInserted: CONFIG.INSERT_USERS,
            sampleDataInserted: CONFIG.INSERT_SAMPLE_DATA
        },
        endpoints: {
            products: "/api/products",
            users: "/api/users",
            clients: "/api/clients",
            workers: "/api/workers",
            invoices: "/api/invoices",
            payments: "/api/payments",
            batches: "/api/batches",
            statistics: "/api/statistics",
            inventory: "/api/inventory",
            audit: "/api/audit",
            alerts: "/api/alerts",
            receipts: "/api/receipts"
        }
    });
});

// ========== FUNCI√ìN PARA INSERTAR USUARIOS POR DEFECTO ==========
async function createDefaultUsers() {
    try {
        console.log('\nüë• Creando usuarios por defecto...\n');

        // 1. Usuario ADMINISTRADOR
        const adminExists = await db.User.findOne({ where: { username: 'admin' }});
        if (!adminExists) {
            const adminPassword = await bcrypt.hash('admin123', 12);
            const adminUser = await db.User.create({
                username: 'admin',
                password: adminPassword,
                role: 'administrador',
                userType: 'trabajador',
                dpi: '1111111111111'
            });
            
            await db.Worker.create({
                name: 'Administrador Principal',
                dpi: '1111111111111',
                birthDate: '1990-01-01',
                email: 'admin@farmacia.com',
                phone: '1111-1111',
                address: 'Ciudad de Guatemala',
                role: 'Administrador',
                userId: adminUser.id
            });
            
            console.log('  ‚úÖ ADMINISTRADOR creado:');
            console.log('     üë§ Usuario: admin');
            console.log('     üîë Contrase√±a: admin123');
            console.log('     üìù DPI: 1111111111111');
            console.log('     üìß Email: admin@farmacia.com\n');
        } else {
            console.log('  ‚ÑπÔ∏è  Usuario ADMINISTRADOR ya existe\n');
        }

        // 2. Usuario VENDEDOR
        const workerExists = await db.User.findOne({ where: { username: 'vendedor' }});
        if (!workerExists) {
            const workerPassword = await bcrypt.hash('vendedor123', 12);
            const workerUser = await db.User.create({
                username: 'vendedor',
                password: workerPassword,
                role: 'vendedor',
                userType: 'trabajador',
                dpi: '2222222222222'
            });
            
            await db.Worker.create({
                name: 'Juan P√©rez',
                dpi: '2222222222222',
                birthDate: '1995-05-15',
                email: 'vendedor@farmacia.com',
                phone: '2222-2222',
                address: 'Guatemala',
                role: 'Vendedor',
                userId: workerUser.id
            });
            
            console.log('  ‚úÖ VENDEDOR creado:');
            console.log('     üë§ Usuario: vendedor');
            console.log('     üîë Contrase√±a: vendedor123');
            console.log('     üìù DPI: 2222222222222');
            console.log('     üìß Email: vendedor@farmacia.com\n');
        } else {
            console.log('  ‚ÑπÔ∏è  Usuario VENDEDOR ya existe\n');
        }

        // 3. Usuario CLIENTE
        const clientExists = await db.User.findOne({ where: { username: 'cliente' }});
        if (!clientExists) {
            const clientPassword = await bcrypt.hash('cliente123', 12);
            const clientUser = await db.User.create({
                username: 'cliente',
                password: clientPassword,
                role: 'cliente',
                userType: 'cliente',
                dpi: '3333333333333'
            });
            
            await db.Client.create({
                name: 'Mar√≠a Garc√≠a',
                dpi: '3333333333333',
                birthDate: '1992-08-20',
                email: 'cliente@farmacia.com',
                phone: '3333-3333',
                address: 'Ciudad de Guatemala',
                userId: clientUser.id
            });
            
            console.log('  ‚úÖ CLIENTE creado:');
            console.log('     üë§ Usuario: cliente');
            console.log('     üîë Contrase√±a: cliente123');
            console.log('     üìù DPI: 3333333333333');
            console.log('     üìß Email: cliente@farmacia.com\n');
        } else {
            console.log('  ‚ÑπÔ∏è  Usuario CLIENTE ya existe\n');
        }

        console.log('‚úÖ Usuarios por defecto completados!\n');
        
    } catch (error) {
        console.error('‚ùå Error al crear usuarios:', error.message);
        throw error;
    }
}

// ========== FUNCI√ìN PARA INSERTAR DATOS DE PRUEBA ==========
async function createSampleData() {
    try {
        console.log('üì¶ Creando datos de prueba...\n');

        // Producto de prueba
        const productExists = await db.Product.findOne({ where: { name: 'Paracetamol 500mg' }});
        if (!productExists) {
            const product = await db.Product.create({
                name: 'Paracetamol 500mg',
                description: 'Analg√©sico y antipir√©tico',
                price: 25.50,
                stock: 100,
                supplier: 'Farmac√©uticos Unidos'
            });
            console.log('  ‚úÖ Producto creado: Paracetamol 500mg');

            // Lote de prueba
            await db.Batch.create({
                productId: product.id,
                batchNumber: 'LOT-2025-001',
                manufacturingDate: '2025-01-01',
                expirationDate: '2027-01-01',
                quantity: 100,
                initialQuantity: 100,
                purchasePrice: 20.00,
                salePrice: 25.50,
                supplier: 'Farmac√©uticos Unidos',
                location: 'Bodega A',
                status: 'active'
            });
            console.log('  ‚úÖ Lote creado: LOT-2025-001\n');
        } else {
            console.log('  ‚ÑπÔ∏è  Datos de prueba ya existen\n');
        }

    } catch (error) {
        console.error('‚ùå Error al crear datos de prueba:', error.message);
    }
}

// ========== SINCRONIZAR BASE DE DATOS ==========
async function initDatabase() {
    try {
        console.log('\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë       üè• FARMACIA ELIZABETH - INICIALIZACI√ìN            ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

        // Mostrar configuraci√≥n actual
        console.log('‚öôÔ∏è  CONFIGURACI√ìN ACTUAL:');
        console.log(`   üìã Recrear tablas: ${CONFIG.RECREATE_TABLES ? '‚úÖ SI' : '‚ùå NO'}`);
        console.log(`   üë• Insertar usuarios: ${CONFIG.INSERT_USERS ? '‚úÖ SI' : '‚ùå NO'}`);
        console.log(`   üì¶ Datos de prueba: ${CONFIG.INSERT_SAMPLE_DATA ? '‚úÖ SI' : '‚ùå NO'}\n`);

        // PASO 1: Sincronizar base de datos
        if (CONFIG.RECREATE_TABLES) {
            console.log('üîÑ RECREANDO TABLAS (se eliminar√°n datos existentes)...\n');
            await db.sequelize.sync({ force: true });
            console.log('‚úÖ Tablas recreadas correctamente\n');
        } else {
            console.log('üîß Sincronizando base de datos (sin eliminar datos)...\n');
            await db.sequelize.sync();
            console.log('‚úÖ Base de datos sincronizada\n');
        }

        // PASO 2: Insertar usuarios por defecto
        if (CONFIG.INSERT_USERS) {
            await createDefaultUsers();
        } else {
            console.log('‚è≠Ô∏è  Omitiendo creaci√≥n de usuarios por defecto\n');
        }

        // PASO 3: Insertar datos de prueba
        if (CONFIG.INSERT_SAMPLE_DATA) {
            await createSampleData();
        } else {
            console.log('‚è≠Ô∏è  Omitiendo datos de prueba\n');
        }

        // Mostrar resumen
        console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
        console.log('‚ïë              ‚úÖ INICIALIZACI√ìN COMPLETADA               ‚ïë');
        console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

        if (CONFIG.INSERT_USERS) {
            console.log('üìä USUARIOS DISPONIBLES:');
            console.log('   1. admin / admin123 (Administrador)');
            console.log('   2. vendedor / vendedor123 (Vendedor)');
            console.log('   3. cliente / cliente123 (Cliente)\n');
        }

        console.log('üì¶ Modelos cargados:', Object.keys(db).filter(key => 
            key !== 'Sequelize' && key !== 'sequelize'
        ).join(', '));
        console.log('\n');

    } catch (err) {
        console.error('\n‚ùå ERROR AL INICIALIZAR LA BASE DE DATOS:');
        console.error(err);
        process.exit(1);
    }
}

// Inicializar base de datos
initDatabase();

// ========== INICIAR SERVIDOR ==========
const PORT = process.env.PORT || 5000;
app.listen(PORT, () => {
    console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    console.log('‚ïë          üöÄ FARMACIA ELIZABETH - API ACTIVA             ‚ïë');
    console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    console.log(`\nüìç Servidor corriendo en: http://localhost:${PORT}`);
    console.log(`üìö Documentaci√≥n API: http://localhost:${PORT}/\n`);
    
    console.log('üí° Para cambiar la configuraci√≥n:');
    console.log('   1. Abre server.js');
    console.log('   2. Edita las variables en CONFIG (l√≠neas 16-24)');
    console.log('   3. Reinicia el servidor (Ctrl+C y npm start)\n');
});